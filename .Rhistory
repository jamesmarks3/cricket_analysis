t20s_summaries <- t20s_summaries %>%
filter(!is.na(winner)) %>%
mutate(city = coalesce(city, word(venue, 1)),
across(starts_with("daily_"),
~ ifelse(is.na(.x), median(.x, na.rm = TRUE), .x)),
across(matches("^innings_1_over_[0-9]+_score$"),
~ ifelse(is.na(.x), coalesce(.x, innings_1_total), .x)),
across(matches("^innings_2_over_[0-9]+_score$"),
~ ifelse(is.na(.x), coalesce(.x, innings_1_total), .x))) %>%
rowwise() %>%
mutate(across(matches("^innings_1_over_[0-9]+_wickets$"),
~ ifelse(is.na(.x),
max(c_across(matches("^innings_1_over_[0-9]+_wickets$")), na.rm = TRUE),
.x)),
across(matches("^innings_2_over_[0-9]+_wickets$"),
~ ifelse(is.na(.x),
max(0, c_across(matches("^innings_2_over_[0-9]+_wickets$")), na.rm = TRUE),
.x))) %>%
ungroup() %>%
filter(!is.na(innings_2_total)) %>%
select(- innings_1_total, - innings_2_total, - daily_sunset) # sunset causes more hassle than it's worth
t20s_summaries <- t20s_summaries %>%
mutate(team_1_win = ifelse(team1 == winner, 1, 0),
train_test = case_when(
start_date >= as.Date("2024-01-01") ~ "test",
TRUE ~ "train"
))
trim_overs <- function(df, num_overs = 20) {
in1_limit <- min(num_overs, 20)
in2_limit <- max(num_overs - 20, 0)
cols <- names(df)
is_over <- grepl("innings_\\d_over_\\d+_", cols)
inning <- ifelse(
is_over,
as.numeric(sub("innings_(\\d)_.*", "\\1", cols)),
NA
)
over <- ifelse(
is_over,
as.numeric(sub(".*_over_(\\d+)_.*", "\\1", cols)),
NA
)
keep <- cols[is.na(inning) | (inning == 1 & over <= in1_limit) | (inning == 2 & over <= in2_limit)]
df[, keep, drop = FALSE]
}
params <- list(
objective = "binary:logistic",
eval_metric = "auc",
eta = 0.05,
max_depth = 5
)
xgboost_df <- function(df) {
df <- df %>%
mutate(across(where(is.character), as.factor)) %>%
drop_na() # redundant after na cleaning earlier
mm <- model.matrix(team_1_win ~ . - match_id - train_test - winner - 1, data = df)
X_train <- mm[df$train_test == "train", , drop = FALSE]
X_test  <- mm[df$train_test == "test",  , drop = FALSE]
y_train <- df$team_1_win[df$train_test == "train"]
y_test  <- df$team_1_win[df$train_test == "test"]
dtrain <- xgb.DMatrix(X_train, label = y_train)
dtest  <- xgb.DMatrix(X_test,  label = y_test)
xgb_model <- xgb.train(
params,
data = dtrain,
nrounds = 500,
watchlist = list(train = dtrain, test = dtest),
early_stopping_rounds = 20,
verbose = 0
)
return(list(
model     = xgb_model,
dtrain    = dtrain,
dtest     = dtest,
X_train   = X_train,
X_test    = X_test,
y_train   = y_train,
y_test    = y_test,
mm        = mm
))
}
xgb_result_30 <- xgboost_df(trim_overs(t20s_summaries, 30))
xgb_importance_30 <- xgb.importance(
model = xgb_result_30$model,
feature_names = xgb_result_30$feature_names
)
xgb_importance_30 %>%
slice_max(Gain, n = 20) %>%     # show top 20
ggplot(aes(x = reorder(Feature, Gain), y = Gain)) +
geom_col() +
coord_flip() +
labs(
title = "Top Predictive Features (30 overs)",
x = "Feature",
y = "Importance (Gain)"
) +
theme_minimal()
xgb_train_model_and_get_auc <- function(num_overs) {
df_trim <- trim_overs(t20s_summaries, num_overs)
result <- xgboost_df(df_trim)
preds <- predict(result$model, result$dtest)
auc_val <- pROC::auc(result$y_test, preds)
return(auc_val)
}
overs_vec <- seq(0, 40, 2)
xgb_auc_results <- sapply(overs_vec, xgb_train_model_and_get_auc)
data.frame(overs = overs_vec, auc = xgb_auc_results)
ggplot(data.frame(overs = overs_vec, auc = xgb_auc_results),
aes(x = overs, y = auc)) +
geom_line() +
geom_point() +
scale_y_continuous(limits = c(0, 1)) +
labs(
title = "Predictive Power vs Number of Known Overs",
x = "Overs Included",
y = "AUC"
)
predictors <- t20s_summaries %>% select(-team_1_win, -train_test)
numeric_cols <- predictors %>% select(where(is.numeric))
categorical_cols <- predictors %>% select(where(is.character))
categorical_matrix <- model.matrix(~ . -1, data = categorical_cols)
numeric_scaled <- scale(numeric_cols)
X <- cbind(numeric_scaled, categorical_matrix)
y <- t20s_summaries$team_1_win
X_train <- X[t20s_summaries$train_test == "train", ]
y_train <- y[t20s_summaries$train_test == "train"]
X_test <- X[t20s_summaries$train_test == "test", ]
y_test <- y[t20s_summaries$train_test == "test"]
model <- keras_model_sequential() %>%
layer_dense(units = 64, activation = "relu", input_shape = ncol(X_train)) %>%
layer_dense(units = 32, activation = "relu") %>%
layer_dense(units = 1, activation = "sigmoid")  # sigmoid for binary classification
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"keras",
"tensorflow")
install_tensorflow()
predictors <- t20s_summaries %>% select(-team_1_win, -train_test)
numeric_cols <- predictors %>% select(where(is.numeric))
categorical_cols <- predictors %>% select(where(is.character))
categorical_matrix <- model.matrix(~ . -1, data = categorical_cols)
numeric_scaled <- scale(numeric_cols)
X <- cbind(numeric_scaled, categorical_matrix)
y <- t20s_summaries$team_1_win
X_train <- X[t20s_summaries$train_test == "train", ]
y_train <- y[t20s_summaries$train_test == "train"]
X_test <- X[t20s_summaries$train_test == "test", ]
y_test <- y[t20s_summaries$train_test == "test"]
model <- keras_model_sequential() %>%
layer_dense(units = 64, activation = "relu", input_shape = ncol(X_train)) %>%
layer_dense(units = 32, activation = "relu") %>%
layer_dense(units = 1, activation = "sigmoid")  # sigmoid for binary classification
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"keras",
"tensorflow",
"reticulate")
use_python("C:\Users\jasmm\OneDrive\Documents\Apps\python-3.9.0-amd64.exe", required = TRUE)
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"keras",
"tensorflow",
"reticulate")
use_python("C:/Users/jasmm/AppData/Local/Microsoft/WindowsApps/python.exe", required = TRUE)
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"keras",
"tensorflow",
"reticulate")
use_python("C:\Windows\py.exe", required = TRUE)
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"keras",
"tensorflow",
"reticulate")
use_python("C:\\Windows\\py.exe", required = TRUE)
t20s_mlp <- t20s_summaries %>%
mutate(across(where(is.character), as.factor))
model = neuralnet(
team_1_win ~ . - match_id - train_test - winner - train_test,
data=t20s_mlp,
hidden=c(4,2),
linear.output = FALSE
)
t20s_mlp_numeric <- t20s_summaries %>%
select(where(is.numeric))
t20s_mlp_categorical <- t20s_summaries %>%
select(where(is.character))
model = neuralnet(
team_1_win ~ . - match_id - train_test - winner - train_test,
data=t20s_mlp,
hidden=c(4,2),
linear.output = FALSE
)
View(t20s_mlp_categorical)
t20s_mlp_numeric <- t20s_summaries %>%
select(where(is.numeric))
t20s_mlp_categorical <- t20s_summaries %>%
select(where(is.character))
categorical_matrix <- model.matrix(~ . -1, data = categorical_cols)
model = neuralnet(
team_1_win ~ . - match_id - train_test - winner - train_test,
data=t20s_mlp,
hidden=c(4,2),
linear.output = FALSE
)
View(categorical_matrix)
t20s_mlp_numeric <- t20s_summaries %>%
select(where(is.numeric)) %>%
scale()
t20s_mlp_categorical <- t20s_summaries %>%
select(where(is.character))
categorical_matrix <- model.matrix(~ . -1, data = categorical_cols)
model = neuralnet(
team_1_win ~ . - match_id - train_test - winner - train_test,
data=t20s_mlp,
hidden=c(4,2),
linear.output = FALSE
)
View(t20s_mlp_numeric)
View(t20s_mlp_categorical)
knitr::opts_chunk$set(echo = TRUE)
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"recipes")
for (lib in libs) {
tidy_lib(lib)
}
set.seed(123)
summaries_path <- path("data", "processed", "t20s_processed.csv")
t20s_summaries <- read.csv(summaries_path)
t20s_summaries <- t20s_summaries %>%
filter(!is.na(winner)) %>%
mutate(start_date = as.Date.numeric(start_date),
city = coalesce(city, word(venue, 1)),
across(starts_with("daily_"),
~ ifelse(is.na(.x), median(.x, na.rm = TRUE), .x)),
across(matches("^innings_1_over_[0-9]+_score$"),
~ ifelse(is.na(.x), coalesce(.x, innings_1_total), .x)),
across(matches("^innings_2_over_[0-9]+_score$"),
~ ifelse(is.na(.x), coalesce(.x, innings_1_total), .x))) %>%
rowwise() %>%
mutate(across(matches("^innings_1_over_[0-9]+_wickets$"),
~ ifelse(is.na(.x),
max(c_across(matches("^innings_1_over_[0-9]+_wickets$")), na.rm = TRUE),
.x)),
across(matches("^innings_2_over_[0-9]+_wickets$"),
~ ifelse(is.na(.x),
max(0, c_across(matches("^innings_2_over_[0-9]+_wickets$")), na.rm = TRUE),
.x))) %>%
ungroup() %>%
filter(!is.na(innings_2_total)) %>%
select(- innings_1_total, - innings_2_total, - daily_sunset) # sunset causes more hassle than it's worth
knitr::opts_chunk$set(echo = TRUE)
tidy_lib <- function(lib) {
if (!require(lib, character.only = TRUE)) {
install.packages(lib)
}
library(lib, character.only = TRUE)
}
libs <- c("tidyr",
"dplyr",
"stringr",
"lubridate",
"readr",
"purrr",
"fs",
"xgboost",
"pROC",
"ggplot2",
"Matrix",
"data.table",
"neuralnet",
"recipes")
for (lib in libs) {
tidy_lib(lib)
}
set.seed(123)
summaries_path <- path("data", "processed", "t20s_processed.csv")
t20s_summaries <- read.csv(summaries_path)
t20s_summaries <- t20s_summaries %>%
filter(!is.na(winner)) %>%
mutate(start_date = as.numeric(as.Date(start_date)),
city = coalesce(city, word(venue, 1)),
across(starts_with("daily_"),
~ ifelse(is.na(.x), median(.x, na.rm = TRUE), .x)),
across(matches("^innings_1_over_[0-9]+_score$"),
~ ifelse(is.na(.x), coalesce(.x, innings_1_total), .x)),
across(matches("^innings_2_over_[0-9]+_score$"),
~ ifelse(is.na(.x), coalesce(.x, innings_1_total), .x))) %>%
rowwise() %>%
mutate(across(matches("^innings_1_over_[0-9]+_wickets$"),
~ ifelse(is.na(.x),
max(c_across(matches("^innings_1_over_[0-9]+_wickets$")), na.rm = TRUE),
.x)),
across(matches("^innings_2_over_[0-9]+_wickets$"),
~ ifelse(is.na(.x),
max(0, c_across(matches("^innings_2_over_[0-9]+_wickets$")), na.rm = TRUE),
.x))) %>%
ungroup() %>%
filter(!is.na(innings_2_total)) %>%
select(- innings_1_total, - innings_2_total, - daily_sunset) # sunset causes more hassle than it's worth
t20s_summaries <- t20s_summaries %>%
mutate(team_1_win = ifelse(team1 == winner, 1, 0),
train_test = case_when(
start_date >= as.Date("2024-01-01") ~ "test",
TRUE ~ "train"
))
trim_overs <- function(df, num_overs = 20) {
in1_limit <- min(num_overs, 20)
in2_limit <- max(num_overs - 20, 0)
cols <- names(df)
is_over <- grepl("innings_\\d_over_\\d+_", cols)
inning <- ifelse(
is_over,
as.numeric(sub("innings_(\\d)_.*", "\\1", cols)),
NA
)
over <- ifelse(
is_over,
as.numeric(sub(".*_over_(\\d+)_.*", "\\1", cols)),
NA
)
keep <- cols[is.na(inning) | (inning == 1 & over <= in1_limit) | (inning == 2 & over <= in2_limit)]
df[, keep, drop = FALSE]
}
params <- list(
objective = "binary:logistic",
eval_metric = "auc",
eta = 0.05,
max_depth = 5
)
xgboost_df <- function(df) {
df <- df %>%
mutate(across(where(is.character), as.factor)) %>%
drop_na() # redundant after na cleaning earlier
mm <- model.matrix(team_1_win ~ . - match_id - train_test - winner - 1, data = df)
X_train <- mm[df$train_test == "train", , drop = FALSE]
X_test  <- mm[df$train_test == "test",  , drop = FALSE]
y_train <- df$team_1_win[df$train_test == "train"]
y_test  <- df$team_1_win[df$train_test == "test"]
dtrain <- xgb.DMatrix(X_train, label = y_train)
dtest  <- xgb.DMatrix(X_test,  label = y_test)
xgb_model <- xgb.train(
params,
data = dtrain,
nrounds = 500,
watchlist = list(train = dtrain, test = dtest),
early_stopping_rounds = 20,
verbose = 0
)
return(list(
model     = xgb_model,
dtrain    = dtrain,
dtest     = dtest,
X_train   = X_train,
X_test    = X_test,
y_train   = y_train,
y_test    = y_test,
mm        = mm
))
}
xgb_result_30 <- xgboost_df(trim_overs(t20s_summaries, 30))
xgb_importance_30 <- xgb.importance(
model = xgb_result_30$model,
feature_names = xgb_result_30$feature_names
)
xgb_importance_30 %>%
slice_max(Gain, n = 20) %>%     # show top 20
ggplot(aes(x = reorder(Feature, Gain), y = Gain)) +
geom_col() +
coord_flip() +
labs(
title = "Top Predictive Features (30 overs)",
x = "Feature",
y = "Importance (Gain)"
) +
theme_minimal()
xgb_train_model_and_get_auc <- function(num_overs) {
df_trim <- trim_overs(t20s_summaries, num_overs)
result <- xgboost_df(df_trim)
preds <- predict(result$model, result$dtest)
auc_val <- pROC::auc(result$y_test, preds)
return(auc_val)
}
overs_vec <- seq(0, 40, 2)
xgb_auc_results <- sapply(overs_vec, xgb_train_model_and_get_auc)
data.frame(overs = overs_vec, auc = xgb_auc_results)
ggplot(data.frame(overs = overs_vec, auc = xgb_auc_results),
aes(x = overs, y = auc)) +
geom_line() +
geom_point() +
scale_y_continuous(limits = c(0, 1)) +
labs(
title = "Predictive Power vs Number of Known Overs",
x = "Overs Included",
y = "AUC"
)
t20s_mlp_numeric <- t20s_summaries %>%
select(where(is.numeric)) %>%
scale()
t20s_mlp_categorical <- t20s_summaries %>%
select(where(is.character))
categorical_matrix <- model.matrix(~ . -1, data = categorical_cols)
model = neuralnet(
team_1_win ~ . - match_id - train_test - winner - train_test,
data=t20s_mlp,
hidden=c(4,2),
linear.output = FALSE
)
